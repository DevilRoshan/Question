# EventLoop

> 参考链接：
>
> https://juejin.im/post/5c3d8956e51d4511dc72c200?utm_source=gold_browser_extension#heading-18
>
> https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/
>
> https://v8.js.cn/blog/fast-async/

### 概述

`Event Loop`即事件循环，是指浏览器或`Node`的一种解决`javaScript`单线程运行时不会阻塞的一种机制，也就是我们经常使用**异步**的原理。

注意：

* 本文所讲的是浏览器中的EventLoop，Node中略有不同
* 本文中提到的栈，队列，以及有关js对函数的执行过程等概念会在其他文章中单独解释，自行查找相关概念

### 执行过程

`Javascript` 有一个 `main thread` 主线程和 `call-stack` 调用栈(执行栈)，所有的任务都会被放到调用栈等待主线程执行。调用栈是一个后进先出的**栈**的数据结构，他会使函数代码按序执行。

由于业务需求，我们的操作分为同步和异步两种，而`Javascript`是一种单线程的语言，所以他将任务分为**同步任务**和**异步任务**来保证运行时不会阻塞。

### 同步任务

主线程会将同步任务在调用栈中按照顺序依次执行。就是依照代码的顺序执行。

### 异步任务

主线程执行异步任务但是并不等待其结果，而是将异步任务及其回调函数进行注册，在异步任务有了结果后，将注册的回调函数放入**任务队列**中等待主线程空闲的时候（调用栈被清空），被读取到栈内等待主线程的执行。

### 任务队列

任务队列是一种先进先出的**队列**的数据结构，使任务能够按序排列。

`Javascript`主线程将调用栈中的**同步任务/宏任务**执行完成之后，会去任务队列中取出需要执行的任务到主线程执行。一直到任务队列为空。

任务队列中的任务分为**宏任务**和**微任务**，并且他们有各自的队列，宏任务和微任务就是日常异步操作代码被解析出来的。

#### 宏任务

宏任务包括：`script`全部代码、`setTimeout`、`setInterval`、`setImmediate`（浏览器暂时不支持，只有IE10支持，具体可见[`MDN`](https://developer.mozilla.org/zh-CN/docs/Web/API/Window/setImmediate)）、`I/O`、`UI Rendering`。

每个单独的代码块就是一个宏任务，比如`onLoad事件的回调函数`、`onClick事件的回调函数`和`ajax请求的回调函数`等，都会被解析为一个个宏任务

#### 微任务

`Process.nextTick（Node独有）`、`Promise`、`Object.observe(废弃)`、`MutationObserver`，这些都会被解析为微任务

#### 不同任务处理机制

* 首先，异步完成产生的宏任务会放在任务队列中的宏任务队列中，执行同步任务/宏任务产生的微任务，会放入到微任务队列中。
* 当调用栈为空的时候，主线程会先去微任务队列，将由上一个任务产生的微任务执行完成。
* 当微任务队列为空时，执行下一个宏任务，并将产生的微任务放入微任务队列。
* 一直到任务队列为空

#### 注意

* 微任务是由同步任务或者宏任务产生的，所以每次执行完成同步任务或者宏任务之后都要清空一次任务队列-微任务队列。
* 宏任务是异步任务的回调函数，会在满足条件时放入任务队列中，并且按序执行

### 完整的执行过程

1. 调用栈对所有任务进行入栈，然后主线程执行调用栈中的任务，将其中的异步任务进行注册，同步任务执行，产生的微任务放入任务队列-微任务队列。
2. 期间，或者无论任何时候，异步函数执行完成，会将注册的回调函数放入任务队列-宏任务队列中。
3. 当主线程执行完成调用栈中的任务，会将任务队列-微任务队列中的任务按序执行
4. 任务队列-微任务队列清空后，主线程会将任务队列-宏任务队列中的宏任务取出一个执行，期间产生的微任务再次放入任务队列-微任务队列，执行完成宏任务后，重复步骤3
5. 一直到任务队列为空

